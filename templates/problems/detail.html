{% extends 'base.html' %}

{% block title %}Problem - LeetCode Clone{% endblock %}

{% block extra_css %}
<style>
    #editor {
        height: 500px;
        border: 1px solid #e5e7eb;
    }
    .resizable-panel {
        min-height: 300px;
    }
</style>
{% endblock %}

{% block content %}
<div class="h-screen flex flex-col">
    <!-- Top Bar -->
    <div class="bg-white border-b px-4 py-3">
        <div class="flex justify-between items-center">
            <a href="/problems/" class="text-blue-600 hover:text-blue-700">
                <i class="fas fa-arrow-left mr-2"></i>Back to Problems
            </a>
            <div id="problemTitle" class="text-lg font-semibold"></div>
            <div></div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex overflow-hidden">
        <!-- Left Panel - Problem Description -->
        <div class="w-1/2 overflow-y-auto border-r bg-white p-6 resizable-panel">
            <div id="problemContent">
                <!-- Loading -->
                <div id="problemLoading" class="flex items-center justify-center h-full">
                    <i class="fas fa-spinner fa-spin text-4xl text-blue-600"></i>
                </div>
            </div>
        </div>

        <!-- Right Panel - Code Editor -->
        <div class="w-1/2 flex flex-col bg-gray-50">
            <!-- Editor Toolbar -->
            <div class="bg-white border-b px-4 py-3 flex justify-between items-center">
                <select id="languageSelect" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="python">Python</option>
                    <option value="javascript">JavaScript</option>
                    <option value="java">Java</option>
                    <option value="cpp">C++</option>
                </select>
                
                <div class="space-x-2">
                    <button id="runCodeBtn" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition">
                        <i class="fas fa-play mr-2"></i>Run Code
                    </button>
                    <button id="submitBtn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition">
                        <i class="fas fa-check mr-2"></i>Submit
                    </button>
                </div>
            </div>

            <!-- Monaco Editor -->
            <div id="editor" class="flex-1"></div>

            <!-- Output Panel -->
            <div class="bg-white border-t p-4 max-h-64 overflow-y-auto">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-semibold">Output</h3>
                    <button id="clearOutput" class="text-sm text-gray-600 hover:text-gray-800">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="output" class="bg-gray-50 p-3 rounded font-mono text-sm min-h-20">
                    <span class="text-gray-400">Run or submit your code to see output...</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Monaco Editor -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>

<script>
    let editor;
    let currentProblem;
    const problemId = window.location.pathname.split('/')[2];
    
    // Initialize Monaco Editor
    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' }});
    
    require(['vs/editor/editor.main'], function() {
        editor = monaco.editor.create(document.getElementById('editor'), {
            value: '# Write your code here\n',
            language: 'python',
            theme: 'vs-light',
            minimap: { enabled: false },
            fontSize: 14,
            lineNumbers: 'on',
            roundedSelection: false,
            scrollBeyondLastLine: false,
            automaticLayout: true,
        });
        
        loadProblem();
    });
    
    // Language change handler
    document.getElementById('languageSelect').addEventListener('change', (e) => {
        const language = e.target.value;
        let monacoLang = language;
        if (language === 'cpp') monacoLang = 'cpp';
        
        monaco.editor.setModelLanguage(editor.getModel(), monacoLang);
        
        // Load starter code
        if (currentProblem) {
            const starterCodeKey = `starter_code_${language}`;
            const starterCode = currentProblem[starterCodeKey] || `// Write your ${language} code here\n`;
            editor.setValue(starterCode);
        }
    });
    
    // Load problem details
    async function loadProblem() {
        try {
            const response = await fetch(`${API_BASE_URL}/api/problems/${problemId}/`);
            const problem = await response.json();
            currentProblem = problem;
            
            renderProblem(problem);
            
            // Load starter code
            const language = document.getElementById('languageSelect').value;
            const starterCodeKey = `starter_code_${language}`;
            const starterCode = problem[starterCodeKey] || '# Write your code here\n';
            editor.setValue(starterCode);
            
        } catch (error) {
            console.error('Failed to load problem:', error);
            document.getElementById('problemContent').innerHTML = `
                <div class="text-center text-red-600">
                    <i class="fas fa-exclamation-circle text-4xl mb-4"></i>
                    <p>Failed to load problem</p>
                </div>
            `;
        }
    }
    
    function renderProblem(problem) {
        document.getElementById('problemLoading').remove();
        document.getElementById('problemTitle').textContent = `${problem.id}. ${problem.title}`;
        
        const difficultyColors = {
            'Easy': 'bg-green-100 text-green-800',
            'Medium': 'bg-yellow-100 text-yellow-800',
            'Hard': 'bg-red-100 text-red-800'
        };
        
        let examplesHtml = '';
        if (problem.examples && problem.examples.length > 0) {
            examplesHtml = problem.examples.map((ex, idx) => `
                <div class="mb-4">
                    <p class="font-semibold">Example ${idx + 1}:</p>
                    <div class="bg-gray-50 p-3 rounded mt-2 font-mono text-sm">
                        <p><strong>Input:</strong> ${ex.input || ''}</p>
                        <p><strong>Output:</strong> ${ex.output || ''}</p>
                        ${ex.explanation ? `<p><strong>Explanation:</strong> ${ex.explanation}</p>` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        // Display test cases if available
        let testCasesHtml = '';
        if (problem.test_cases && problem.test_cases.length > 0) {
            testCasesHtml = `
                <div class="mt-6">
                    <h3 class="text-lg font-semibold mb-3">Sample Test Cases</h3>
                    ${problem.test_cases.map((tc, idx) => `
                        <div class="mb-3 bg-gray-50 p-3 rounded">
                            <p class="font-semibold">Test Case ${idx + 1}:</p>
                            <div class="font-mono text-sm mt-2">
                                <p><strong>Input:</strong> ${tc.input_data}</p>
                                <p><strong>Expected Output:</strong> ${tc.expected_output}</p>
                                ${tc.explanation ? `<p class="mt-1 text-gray-600">${tc.explanation}</p>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        document.getElementById('problemContent').innerHTML = `
            <div>
                <h1 class="text-2xl font-bold mb-4">${problem.id}. ${problem.title}</h1>
                
                <div class="flex gap-2 mb-4">
                    <span class="px-3 py-1 rounded-full text-sm font-semibold ${difficultyColors[problem.difficulty]}">
                        ${problem.difficulty}
                    </span>
                    <span class="px-3 py-1 rounded-full text-sm bg-blue-100 text-blue-800">
                        ${problem.category}
                    </span>
                </div>
                
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-2">Description</h3>
                    <div class="text-gray-700 whitespace-pre-wrap">${problem.description}</div>
                </div>
                
                ${examplesHtml}
                ${testCasesHtml}
                
                ${problem.constraints ? `
                    <div class="mt-6">
                        <h3 class="text-lg font-semibold mb-2">Constraints</h3>
                        <div class="text-gray-700 whitespace-pre-wrap">${problem.constraints}</div>
                    </div>
                ` : ''}
                
                <div class="mt-6 text-sm text-gray-600">
                    <p>Acceptance: ${problem.acceptance_rate.toFixed(1)}%</p>
                    <p>Submissions: ${problem.total_submissions}</p>
                </div>
            </div>
        `;
    }
    
    // Run Code
    document.getElementById('runCodeBtn').addEventListener('click', async () => {
        const code = editor.getValue();
        const language = document.getElementById('languageSelect').value;
        const outputDiv = document.getElementById('output');
        const runBtn = document.getElementById('runCodeBtn');
        
        if (!isAuthenticated()) {
            outputDiv.innerHTML = '<span class="text-red-600">Please login to run code</span>';
            return;
        }
        
        runBtn.disabled = true;
        runBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Running...';
        outputDiv.innerHTML = '<span class="text-blue-600"><i class="fas fa-spinner fa-spin mr-2"></i>Running tests...</span>';
        
        try {
            const response = await fetchWithAuth(`${API_BASE_URL}/api/submissions/run/${problemId}/`, {
                method: 'POST',
                body: JSON.stringify({ code, language }),
            });
            
            const data = await response.json();
            
            if (response.ok) {
                let resultsHtml = '<div class="space-y-3">';
                data.results.forEach((result, idx) => {
                    const statusColor = result.status === 'Accepted' ? 'text-green-600' : 'text-red-600';
                    resultsHtml += `
                        <div class="border-l-4 ${result.status === 'Accepted' ? 'border-green-500' : 'border-red-500'} pl-3">
                            <p class="font-semibold ${statusColor}">${result.status}</p>
                            <p class="text-sm"><strong>Input:</strong> ${result.input}</p>
                            <p class="text-sm"><strong>Expected:</strong> ${result.expected_output}</p>
                            <p class="text-sm"><strong>Output:</strong> ${result.actual_output || 'N/A'}</p>
                            ${result.error ? `<p class="text-sm text-red-600"><strong>Error:</strong> ${result.error}</p>` : ''}
                            ${result.runtime ? `<p class="text-xs text-gray-600">Runtime: ${result.runtime}s</p>` : ''}
                        </div>
                    `;
                });
                resultsHtml += '</div>';
                outputDiv.innerHTML = resultsHtml;
            } else {
                outputDiv.innerHTML = `<span class="text-red-600">Error: ${data.error || 'Failed to run code'}</span>`;
            }
        } catch (error) {
            outputDiv.innerHTML = `<span class="text-red-600">Error: ${error.message}</span>`;
        } finally {
            runBtn.disabled = false;
            runBtn.innerHTML = '<i class="fas fa-play mr-2"></i>Run Code';
        }
    });
    
    // Submit Code
    document.getElementById('submitBtn').addEventListener('click', async () => {
        const code = editor.getValue();
        const language = document.getElementById('languageSelect').value;
        const outputDiv = document.getElementById('output');
        const submitBtn = document.getElementById('submitBtn');
        
        if (!isAuthenticated()) {
            outputDiv.innerHTML = '<span class="text-red-600">Please login to submit</span>';
            return;
        }
        
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...';
        outputDiv.innerHTML = '<span class="text-blue-600"><i class="fas fa-spinner fa-spin mr-2"></i>Judging submission...</span>';
        
        try {
            const response = await fetchWithAuth(`${API_BASE_URL}/api/submissions/`, {
                method: 'POST',
                body: JSON.stringify({ problem: problemId, code, language }),
            });
            
            const submission = await response.json();
            
            if (response.ok) {
                const statusColor = submission.status === 'Accepted' ? 'text-green-600' : 'text-red-600';
                let resultHtml = `
                    <div>
                        <p class="text-xl font-bold ${statusColor} mb-3">${submission.status}</p>
                        <p class="text-sm">Test Cases: ${submission.passed_test_cases}/${submission.total_test_cases} passed</p>
                        ${submission.runtime ? `<p class="text-sm">Runtime: ${submission.runtime} ms</p>` : ''}
                        ${submission.memory ? `<p class="text-sm">Memory: ${submission.memory} KB</p>` : ''}
                        ${submission.error_message ? `<p class="text-sm text-red-600 mt-2"><strong>Error:</strong> ${submission.error_message}</p>` : ''}
                `;
                
                if (submission.failed_test_case && submission.failed_test_case.is_sample) {
                    resultHtml += `
                        <div class="mt-3 p-3 bg-red-50 rounded">
                            <p class="font-semibold text-red-800">Failed Test Case:</p>
                            <p class="text-sm"><strong>Input:</strong> ${submission.failed_test_case.input}</p>
                            <p class="text-sm"><strong>Expected:</strong> ${submission.failed_test_case.expected}</p>
                            <p class="text-sm"><strong>Your Output:</strong> ${submission.failed_test_case.output || 'N/A'}</p>
                        </div>
                    `;
                }
                
                resultHtml += '</div>';
                outputDiv.innerHTML = resultHtml;
                
                if (submission.status === 'Accepted') {
                    setTimeout(() => {
                        outputDiv.innerHTML += `
                            <div class="mt-4 p-3 bg-green-50 rounded text-green-800">
                                <p class="font-semibold"><i class="fas fa-trophy mr-2"></i>Congratulations!</p>
                                <p class="text-sm">Your solution has been accepted!</p>
                            </div>
                        `;
                    }, 500);
                }
            } else {
                outputDiv.innerHTML = `<span class="text-red-600">Submission failed</span>`;
            }
        } catch (error) {
            outputDiv.innerHTML = `<span class="text-red-600">Error: ${error.message}</span>`;
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Submit';
        }
    });
    
    // Clear output
    document.getElementById('clearOutput').addEventListener('click', () => {
        document.getElementById('output').innerHTML = '<span class="text-gray-400">Run or submit your code to see output...</span>';
    });
</script>
{% endblock %}
